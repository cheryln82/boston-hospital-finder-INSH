<!DOCTYPE html>
<html>
<head>
  <title>Boston Hospital Finder</title>
  <meta charset="UTF-8">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; }

    #header { background: #003087; color: white; padding: 16px 24px; }
    #header h1 { font-size: 22px; }
    #header p  { font-size: 13px; opacity: 0.8; margin-top: 4px; }

    #controls {
      background: white; padding: 14px 24px;
      display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
      border-bottom: 1px solid #ddd;
    }

    input, select, button {
      padding: 8px 12px; font-size: 15px;
      border: 1px solid #ccc; border-radius: 4px;
    }

    button { background: #003087; color: white; border: none; cursor: pointer; }
    button:hover { background: #00205b; }

    #main { display: flex; height: calc(100vh - 110px); }

    #map { flex: 1; }

    #sidebar {
      width: 320px;
      background: white;
      border-left: 1px solid #ddd;
      display: flex; flex-direction: column;
      overflow: hidden;
    }

    #sidebar-header {
      padding: 12px 16px; background: #f9f9f9;
      border-bottom: 1px solid #ddd; font-size: 13px; color: #555;
    }

    #results { overflow-y: auto; flex: 1; padding: 10px; }
    #loading { display: none; padding: 20px; text-align: center; }

    .hospital-card {
      border: 1px solid #ddd; border-radius: 6px;
      padding: 10px 12px; margin-bottom: 8px;
      cursor: pointer;
    }

    .hospital-card:hover { border-color: #003087; }
    .hospital-card.active { border-color: #003087; background: #f0f4ff; }

    .dist-badge {
      background: #003087; color: white;
      border-radius: 10px; padding: 2px 8px; font-size: 11px;
    }

    .leaflet-popup-content table {
      width: 100%;
      font-size: 12px;
    }
  </style>
</head>
<body>

<div id="header">
  <h1>üè• Boston Hospital Finder</h1>
  <p>Find nearby hospitals and explore neighborhood vulnerability</p>
</div>

<div id="controls">
  <input type="text" id="zip" placeholder="Enter ZIP code (e.g. 02115)" maxlength="5">
  <select id="radius">
    <option value="1">1 mile</option>
    <option value="5" selected>5 miles</option>
    <option value="10">10 miles</option>
  </select>
  <button onclick="findHospitals()">Search</button>
</div>

<div id="main">
  <div id="map"></div>
  <div id="sidebar">
    <div id="sidebar-header">Enter a ZIP code to begin</div>
    <div id="loading">Loading...</div>
    <div id="results"></div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const HOSPITAL_CSV = "https://data.boston.gov/dataset/d9871e89-2d1e-4ecf-b0de-046f553027c0/resource/6222085d-ee88-45c6-ae40-0c7464620d64/download/hospital-locations.csv";
const VULN_CSV     = "https://bostonopendata-boston.opendata.arcgis.com/api/download/v1/items/34f2c48b670d4b43a617b1540f20efe3/csv?layers=0";

let map;
let markersLayer;
let vulnByNeigh = {};

// Init map
function initMap() {
  map = L.map("map").setView([42.3601, -71.0589], 12);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  markersLayer = L.layerGroup().addTo(map);
}

// Marker factory
function makeMarker(lat, lon) {
  return L.circleMarker([lat, lon], {
    radius: 8,
    fillColor: "#003087",
    color: "white",
    weight: 2,
    fillOpacity: 0.9
  });
}

// Load vulnerability (OlderAdult + TotDis)
function loadVulnerability(rows) {
  const grouped = {};

  rows.forEach(r => {
    const name = (r["NAME"] || "").toUpperCase();
    const pop = parseFloat(r["POP"]) || 0;
    const older = parseFloat(r["OLDERADULT"]) || 0;
    const dis = parseFloat(r["TOTDIS"]) || 0;

    if (!grouped[name]) grouped[name] = { pop:0, older:0, dis:0 };

    grouped[name].pop += pop;
    grouped[name].older += older;
    grouped[name].dis += dis;
  });

  Object.keys(grouped).forEach(name => {
    const g = grouped[name];
    if (g.pop > 0) {
      vulnByNeigh[name] = {
        olderPct: (g.older / g.pop) * 100,
        disPct: (g.dis / g.pop) * 100
      };
    }
  });
}

// Popup builder
function makePopupHTML(h, vuln) {
  if (!vuln) {
    return `<b>${h.NAME}</b><br>${h.AD || ""}<br>No vulnerability data`;
  }

  return `
    <b>${h.NAME}</b><br>
    ${h.AD || ""}
    <hr>
    <table>
      <tr><td>% Elderly (65+)</td><td>${vuln.olderPct.toFixed(1)}%</td></tr>
      <tr><td>% Disabled</td><td>${vuln.disPct.toFixed(1)}%</td></tr>
    </table>
  `;
}

// Distance
function distMiles(lat1, lon1, lat2, lon2) {
  const dLat = (lat2 - lat1) * 69;
  const dLon = (lon2 - lon1) * 52;
  return Math.sqrt(dLat*dLat + dLon*dLon);
}

// ZIP lookup
async function getZipCoords(zip) {
  const res = await fetch(`https://api.zippopotam.us/us/${zip}`);
  if (!res.ok) return null;
  const d = await res.json();
  return {
    lat: parseFloat(d.places[0].latitude),
    lon: parseFloat(d.places[0].longitude),
    city: d.places[0]["place name"],
    state: d.places[0]["state"]
  };
}

// Simple CSV parser (basic)
function parseCSV(text) {
  const lines = text.split("\n");
  const headers = lines[0].split(",").map(h => h.trim().toUpperCase());
  return lines.slice(1).map(line => {
    const vals = line.split(",");
    const obj = {};
    headers.forEach((h,i)=> obj[h]=vals[i]);
    return obj;
  });
}

// Main search
async function findHospitals() {
  const zip = document.getElementById("zip").value.trim();
  const radius = parseFloat(document.getElementById("radius").value);

  markersLayer.clearLayers();

  const coords = await getZipCoords(zip);
  if (!coords) return;

  const [hospText, vulnText] = await Promise.all([
    fetch(HOSPITAL_CSV).then(r=>r.text()),
    fetch(VULN_CSV).then(r=>r.text())
  ]);

  const hospitals = parseCSV(hospText);
  const vulnRows = parseCSV(vulnText);
  loadVulnerability(vulnRows);

  const coordRx = /\(\s*([-\d.]+),\s*([-\d.]+)\s*\)/;

  const matches = hospitals.map(h => {
    const m = (h["LOCATION"]||"").match(coordRx);
    if (!m) return null;
    const lat = parseFloat(m[1]);
    const lon = parseFloat(m[2]);
    return { ...h, lat, lon, dist: distMiles(coords.lat, coords.lon, lat, lon) };
  }).filter(h=>h && h.dist<=radius)
    .sort((a,b)=>a.dist-b.dist);

  const markers=[];

  matches.forEach(h=>{
    const marker = makeMarker(h.lat, h.lon);
    const vuln = vulnByNeigh[(h.NEIGH||"").toUpperCase()];
    marker.bindPopup(makePopupHTML(h, vuln));
    marker.addTo(markersLayer);
    markers.push(marker);
  });

  if (markers.length) {
    map.fitBounds(L.featureGroup(markers).getBounds().pad(0.2));
  }
}

initMap();
</script>
</body>
</html>